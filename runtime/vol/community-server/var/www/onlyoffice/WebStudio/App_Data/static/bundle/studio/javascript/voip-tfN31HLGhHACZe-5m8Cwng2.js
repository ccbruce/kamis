jQuery.template('operator-status-switcher-options-tmpl', '<ul class="dropdown-content "><li id="operator-online-btn" class="dropdown-item">${ASC.Resources.Master.ResourceJS.OnlineStatus}</li><li id="operator-offline-btn" class="dropdown-item">${ASC.Resources.Master.ResourceJS.OfflineStatus}</li></ul>');
jQuery.template('options-box-tmpl', '<select id="call-type-selector" class="comboBox"><option value="2" class="browser-type-call" {{if answer== 2}} selected="selected" {{/if}}>${ASC.Resources.Master.TemplateResource.Browser}</option>{{each phones}}<option value="0" class="phone-type-call" data-number="${title}" {{if answer== 0 && redirectToNumber== title}} selected="selected" {{/if}}>${title}</option>{{/each}}</select><div id="toggle-missed-box-btn" class="disable"><div class="voip-missed"></div></div><div id="toggle-phone-box-btn" class="disable"><div class="voip-tastatura"></div></div>');
jQuery.template('countries-panel-tmpl', '<div id="countries-panel" class="studio-action-panel"><ul class="dropdown-content">{{each countries}}<li class="dropdown-item"><span class="voip-flag ${iso}" data-iso="${iso}" data-code="${code}"></span>${title}</li>{{/each}}</ul></div>');
jQuery.template('contact-phone-switcher-item-tmpl', '<li class="dropdown-item"><div class="data">${data}</div><div class="category">${categoryName}</div></li>');
jQuery.template('missed-call-tmpl', '<div class="missed-call" data-number="${lastCall.from}"><div class="missed-call-avatar">{{if lastCall.contact != null}}<a href="${\'/Products/CRM/Default.aspx?id=\' + lastCall.contact.id}" target="_blank"><img src="${lastCall.contact.smallFotoUrl}" alt="${lastCall.contact.displayName}" /></a>{{/if}}            {{if callsCount > 1}}<div class="missed-call-group-count">${callsCount}</div>{{/if}}</div><div class="missed-call-contact">{{if lastCall.contact && lastCall.contact.displayName}}<a href="${\'/Products/CRM/Default.aspx?id=\' + lastCall.contact.id}" target="_blank" class="missed-call-name" title="${lastCall.contact.displayName}">${lastCall.contact.displayName}</a><div class="missed-call-number">${lastCall.from}</div>{{else}}<div class="missed-call-number-single">${lastCall.from}</div>{{/if}}</div><div class="recall-btn" data-number="${lastCall.from}"><div></div></div><div class="missed-call-date">${lastCall.time}</div><div class="missed-call-icon"></div></div>');
jQuery.template('operators-redirect-option-tmpl', '<option value="${id}">${displayName}</option>');
jQuery.template('call-tmpl', '{{if contact != null}}<div id="call-avatar"><a href="${\'/Products/CRM/Default.aspx?id=\' + contact.id}" target="_blank"><img src="${contact.mediumFotoUrl}" alt="${contact.displayName}" /></a></div><div id="call-dude"><a href="${\'/Products/CRM/Default.aspx?id=\' + contact.id}" target="_blank" id="dude-name">${contact.displayName}</a><div id="dude-company"></div></div>{{/if}}<div id="call-number"><div id="number-value">{{if status === 0 || status === 2}}${from}{{else}}${to}{{/if}}</div><div id="number-location"></div></div>');

typeof ASC=="undefined"&&(ASC={});typeof ASC.Voip=="undefined"&&(ASC.Voip={});ASC.Voip.Countries=function(){function n(n,t,i){return{iso:n,title:t,code:i}}return[n("US","United States",1),n("AT","Austria",43),n("AU","Australia",61),n("BE","Belgium",32),n("BG","Bulgaria",359),n("CA","Canada",1),n("CH","Switzerland",41),n("CZ","Czech Republic",420),n("DK","Denmark",45),n("ES","Spain",34),n("FI","Finland",358),n("FR","France",33),n("GB","United Kingdom",44),n("GR","Greece",30),n("HK","Hong Kong",852),n("IE","Ireland",353),n("IL","Israel",972),n("IT","Italy",39),n("JP","Japan",81),n("LV","Latvia",371),n("MX","Mexico",52),n("NL","The Netherlands",31),n("NZ","New Zealand",64),n("PL","Poland",48),n("PR","Puerto Rico",1787),n("PT","Portugal",351),n("RO","Romania",40),n("SE","Sweden",46),n("SK","Slovakia",421)]}();
typeof ASC=="undefined"&&(ASC={});typeof ASC.CRM=="undefined"&&(ASC.CRM=function(){return{}});typeof ASC.CRM.Voip=="undefined"&&(ASC.CRM.Voip=function(){return{}});ASC.CRM.Voip.PhoneView=function(n){function tf(){if(ASC.SocketIO&&!ASC.SocketIO.disabled()&&(p=ASC.SocketIO.Factory.voip),typeof p=="undefined"){n(".studio-top-panel .voip").hide();return}document.addEventListener("visibilitychange",function(){ai=document.hidden},!1);ff();ef();sf();yi();p.on("reconnecting",function(){bi(r.offline);k.destroy()}).on("disconnected",function(){y&&(bi(r.offline),k.destroy())}).connect(function(){hf(rf)}).reconnect_failed(function(){ui=!0;o()}).on("status",bi).on("miss",ve).on("onlineAgents",he).on("dequeue",ce).on("reload",function(){location.reload()})}function rf(n){cf(n);p.emit("getStatus",function(n){t.status=n;n!=r.offline&&(ct=!0);o();n===r.offline&&pi(r.online)})}function uf(n){Teamlab.getVoipToken(null,{success:function(t,i){k=new Twilio.Device(i,{disableAudioContextSounds:!0});k.on("ready",function(){y=!0;eu(n)});k.on("incoming",function(n){pe(n)});k.on("cancel",we);k.on("error",function(n){n&&(n.code===31201||n.code===31208)&&pu()});k.on("offline",function(){y=!1;st=null})}})}function ff(){rr=n(".voipActiveBox");gt=n("#studio_dropVoipPopupPanel");l=gt.find("#voip-phone-view");ur="operator-status-switcher-options-tmpl";fr="options-box-tmpl";er="countries-panel-tmpl";or="contact-phone-switcher-item-tmpl";ei="missed-call-tmpl";sr="operators-redirect-option-tmpl";hr="call-tmpl";c=gt.find("#incoming-player").get(0);de()?c.src="https://media.twiliocdn.com/sdk/js/client/sounds/releases/1.0.0/incoming.mp3":ge()?c.src=iu.VoipPhone.IncomingRingtoneWav:c=null;cr=l.find("#service-unavailable-box");oi=l.find("#service-already-running-box");lr=l.find("#view-init-loader-box");g=l.find("#operator-box");ni=g.find("#operator-status");ar=g.find("#operator-name");a=g.find("#operator-status-switcher");ti=g.find("#operator-status-switcher-options");s=l.find("#options-box");it=l.find("#missed-calls-box");rt=l.find("#missed-calls-list");ii=it.find("#missed-calls-empty-msg");v=l.find("#phone-box");si=v.find("#selected-contact");w=v.find("#phone-selector-box");vr=w.find("#country-selector");b=w.find("#phone-input");nt=w.find("#phone-clear-btn");hi=w.find("#contact-phone-switcher-btn");yr=w.find("#contact-phone-switcher-panel");ri=v.find("#select-contact-btn");tt=v.find("#call-btn");e=l.find("#call-box");pr=e.find("#call-status-box");wr=pr.find(".call-status");br=e.find("#call-main-box");nf=e.find("#call-dude");ci=e.find("#call-timer");kr=e.find(".call-btn");dr=e.find(".answer-btn");gr=e.find(".reject-btn");nu=e.find(".complete-btn");at=e.find(".redirect-btn");vt=e.find("#operators-redirect-box");yt=vt.find("#operators-redirect-selector");li=vt.find("#operators-redirect-empty-msg")}function ef(){var n="click";g.on(n,"#operator-online-btn",pi.bind(this,0));g.on(n,"#operator-offline-btn",pi.bind(this,2));a.on(n,gf);s.on("change","#call-type-selector",ne);v.on(n,".panel-btn",re);b.on("keyup",lu);nt.on(n,wi);w.on(n,"#countries-panel .dropdown-item",te);w.on(n,"#contact-phone-switcher-panel .dropdown-item",ie);ri.on("showList",hu);it.on(n,".recall-btn",fe);tt.on(n,ue);dr.on(n,ee);gr.on(n,pu);nu.on(n,se);at.on(n,oe);s.on(n,"#toggle-phone-box-btn",ou);s.on(n,"#toggle-missed-box-btn",su)}function sf(){n.dropdownToggle({switcherSelector:"#operator-status-switcher",dropdownID:"operator-status-switcher-options",addTop:-7,addLeft:9,inPopup:!0});n.dropdownToggle({switcherSelector:"#country-selector",dropdownID:"countries-panel",addTop:8,addLeft:10,inPopup:!0});n.dropdownToggle({switcherSelector:"#contact-phone-switcher-btn",dropdownID:"contact-phone-switcher-panel",addTop:18,addLeft:-207,inPopup:!0});ri.contactadvancedSelector({inPopup:!0,isTempLoad:!0,onechosen:!0})}function hf(n){var t=function(n){return{success:function(t,i){n(null,i)},error:function(t){n(t)}}};async.parallel([function(n){Teamlab.getCrmCurrentVoipNumber(null,t(n))},function(n){Teamlab.getVoipMissedCalls(null,t(n))}],function(t,i){t?et():n(i)})}function ru(n,t){var i;"Notification"in window&&(Notification.permission==="granted"?i=new Notification(t,{body:n}):Notification.permission!=="denied"&&Notification.requestPermission(function(r){r==="granted"&&(i=new Notification(t,{body:n}))}),i&&(i.onclick=function(n){n.preventDefault();window.focus()}))}function cf(n){var r,i,f,h,o,e,s;if("Notification"in window&&Notification.requestPermission(),pt=ASC.Voip.Countries,lt=Teamlab.profile,r=n[0],t=r.settings.caller,fi=r.settings.pause,wt=t.allowOutgoingCalls&&r.settings.allowOutgoingCalls,wt||vu(),vi="+"+r.number,document.title=vi,i=n[1],i.length)for(u.push({lastCall:i[0],callsCount:1}),f=1;f<i.length;f++){for(h=i[f],o=!1,e=0;e<u.length;e++)if(s=u[e],s.lastCall.from==h.from){s.callsCount++;o=!0;break}o||u.push({lastCall:i[f],callsCount:1})}}function lf(n){var t=!1;return u.length&&u[0].lastCall.from==n.from?(t=!0,u[0].lastCall=n,u[0].callsCount++):u.unshift({lastCall:n,callsCount:1}),{repeatedCall:t,call:u[0]}}function af(n){for(var i=[],t=0;t<u.length;t++)u[t].lastCall.from!=n&&i.push(u[t]);u=i}function vf(n){for(var t=UserManager.getUsers(n),i=0;i<t.length;i++)if(t[i].id==lt.id){t.splice(i,1);break}return t}function uu(n){for(var r,t=[],i=0;i<pt.length;i++)r=pt[i],n.indexOf("+"+r.code)==0&&t.push(r);if(t.length==0)return null;if(t.length==1)return t[0];for(i=0;i<t.length;i++)if(t[i].iso==tr)return t[i];return t[0]}function yf(n){t.answer=n.answerType;t.redirectToNumber=n.redirectToNumber}function o(){if(lr.hide(),ui){cr.show();return}if(ct){oi.show();return}oi.hide();fu();pf();wf();bf();kf();i==f.incomingStarted&&df()}function fu(){ti.html(jq.tmpl(ur));ti.hide();ar.text(lt.displayName);t.status==r.online?(ni.removeClass("offline").addClass("online"),a.text(ut.OnlineStatus),a.removeClass("lock")):t.status==r.offline?(ni.removeClass("online").addClass("offline"),a.text(ut.OfflineStatus),a.removeClass("lock")):t.status==r.busy&&(ni.removeClass("offline").addClass("online"),a.text(ut.BusyStatus),a.removeClass("lock"),i!=null&&a.addClass("lock"));g.show()}function pf(){var f,n,u;if(wt){if(i!=null){s.hide();return}f=jq.tmpl(fr,{answer:t.answer,redirectToNumber:t.redirectToNumber,phones:lt.contacts.telephones});s.html(f);n=s.find("#toggle-phone-box-btn");u=s.find("#toggle-missed-box-btn");t.answer==0?(n.hide(),u.hide()):(n.show(),u.show(),t.status===r.offline?(n.addClass(d),u.addClass(d)):(n.removeClass(d),u.removeClass(d)));s.show()}}function wf(){if(i!=null||v.is(":visible")){it.hide();return}if((t.status==r.offline||t.answer==0?it.hide():su(),u.length?ii.hide():ii.show(),!y)&&u.length){ii.hide();var f=n.tmpl(ei,u);rt.html(f)}}function bf(){if(!y){var u=n.tmpl(er,{countries:pt});w.append(u)}if(t.status==r.offline||i!=null||t.answer==0){v.hide();return}}function kf(){if(i==null){e.hide();return}ci.empty();wr.hide().filter("[data-status="+i+"]").show();kr.hide().filter("[data-status="+i+"]").show();i==f.incomingGoing?vt.show():vt.hide();var t=n.tmpl(hr,h);br.html(t);e.show()}function df(){gt.is(":visible")||rr.trigger("click")}function yi(){ht();b.val(gi)}function ht(n){var t=arguments.length==0?nr:n;tr=t;vr.attr("class","voip-flag link arrow-down "+t)}function pi(n){t.status==n?ti.hide():(du(),t.status===r.offline&&n===r.online?uf(n):(t.status===r.online&&n===r.offline&&k.destroy(),eu(n)))}function eu(n){p.emit("status",n,function(){di()})}function gf(){return t.status==r.busy&&i!=null?!1:!0}function ne(t){var u=n(t.target),i=n(t.target).val(),r=i=="0"?{answerType:i,redirectToNumber:u.find(":selected").attr("data-number")}:{answerType:i};du();Teamlab.updateCrmVoipOperator(null,lt.id,r,{success:function(){di();yf(r);o()},error:function(){di();et()}})}function ou(){jq(this).hasClass(d)||(it.hide(),e.hide(),v.show(),s.find("#toggle-missed-box-btn").removeClass(dt),s.find("#toggle-phone-box-btn").addClass(dt))}function su(){jq(this).hasClass(d)||(e.hide(),v.hide(),it.show(),s.find("#toggle-phone-box-btn").removeClass(dt),s.find("#toggle-missed-box-btn").addClass(dt))}function te(t){var i=n(t.currentTarget).find(".voip-flag"),r=i.attr("data-iso"),u=i.attr("data-code");wi();r!=nr?nt.show():nt.hide();ht(r);b.val("+"+u);i.closest(".studio-action-panel").hide()}function ie(t){var i=n(t.currentTarget).find(".data"),r=i.text();cu(r);i.closest(".studio-action-panel").hide()}function hu(n,t){var i,r;ot=t;si.text(t.title).show();t.phone&&t.phone.length?(i=t.phone[0].data,cu(i),r=jq.tmpl(or,t.phone),yr.find(".dropdown-content").html(r),hi.show()):yi();nt.show()}function cu(n){var t=uu(n);t?ht(t.iso):ht();b.val(n)}function re(t){var i=n(t.currentTarget).attr("data-value"),r=b.val()+i;b.val(r);lu()}function lu(){var t=b.val().replace(/\D/g,""),n;t!=gi?nt.show():nt.hide();n=uu(t);n?ht(n.iso):ht();au()}function wi(){yi();nt.hide();au()}function au(){si.hide();hi.hide();ot&&(ri.contactadvancedSelector("unselect",[ot.id]),ot=null)}function ue(){if(!tt.is(".disable")){tt.addClass("disable");var n={to:b.val().replace(/\D/g,""),contactId:ot?ot.id:null};Teamlab.callVoipNumber(null,n,{success:function(n,u){h=u;t.status=r.busy;i=f.outgoingStarted;tt.removeClass("disable");o()},error:function(){et();tt.removeClass("disable")}})}}function fe(u){var e=n(u.currentTarget),s;e.is(".disable")||(e.addClass("disable"),e.closest(".missed-call").addClass("selected"),vu(),s=e.attr("data-number"),Teamlab.callVoipNumber(null,{to:s},{success:function(n,u){h=u;t.status=r.busy;i=f.outgoingStarted;e.removeClass("disable");yu();o();af(s);rt.find('.missed-call[data-number="'+s+'"]').remove()},error:function(){e.removeClass("disable");e.closest(".missed-call").removeClass("selected");yu();et()}}))}function vu(){rt.addClass("lock")}function yu(){wt&&rt.removeClass("lock")}function ee(){Teamlab.answerVoipCall({},h.id,{error:function(){et()}})}function pu(){Teamlab.rejectVoipCall({},h.id,{success:function(){i=f.incomingCompleted;o();ft()},error:function(){et();ft()}})}function oe(){if(!at.is(".disable")){var n=yt.val();Teamlab.redirectVoipCall({},h.id,{to:n},{success:function(){i=f.incomingCompleted;o();ft()},error:function(){et();ft()}})}}function se(){st?st.disconnect():(ki(),i=f.incomingCompleted,o(),ft())}function wu(n){if(!t||t.status!==r.online||i!==null||ui||ct){kt=n;return}kt=null;ou();Teamlab.getCrmContact({},n,{success:function(n,t){var i={title:t.displayName||t.title||t.name||t.Name,id:t.id&&t.id.toString(),phone:t.phone||t.commonData&&t.commonData.filter(function(n){return n.infoType==0})};t.hasOwnProperty("contactclass")&&(i.type=t.contactclass);hu(undefined,i)}})}function bi(n){if(y||(t.status==r.offline&&n==r.online&&(ct=!0),n===r.offline&&(ct=!1)),t.status=n,t.status!=r.online?tt.addClass(d):tt.removeClass(d),t.status==r.busy){fu();return}o();kt&&wu(kt)}function he(n){var t,i;y&&(t=vf(n),t&&t.length?(i=jq.tmpl(sr,t),yt.html(i),at.removeClass("disable"),li.hide(),yt.show()):(yt.hide(),at.addClass("disable"),li.show()))}function ce(n){y&&p.emit("status",1,function(){Teamlab.getVoipCall({},n,{success:function(n,t){if(h=t,i=f.incomingStarted,c&&c.play(),ai){ru(t.from,ut.CallIncoming);var r=setInterval(function(){if(window.closed){clearInterval(r);return}document.title=ut.CallIncoming+":"+t.from;window.focus()},1e3);window.onmousemove=function(){clearInterval(r);document.title=vi;document.onmousemove=null}}o()}})})}function le(){if(i==f.incomingStarted)i=f.incomingGoing,bu();else if(i==f.outgoingStarted)i=f.outgoingGoing;else return;o();be()}function ae(){if(ki(),st&&st.disconnect(),i==f.incomingGoing)i=f.incomingCompleted;else if(i==f.outgoingGoing)i=f.outgoingCompleted;else return;o();ft()}function ve(n){y&&Teamlab.getVoipCall({},n,{success:function(n,t){var i=lf(t),r=jq.tmpl(ei,i.call);i.repeatedCall?rt.find(".missed-call:first").replaceWith(r):rt.prepend(r);ft(0);fi||p.emit("status",0);ai&&ru(t.from,ut.CallMissed)}})}function ft(n){ye();var t=arguments.length==1?n:gu;setTimeout(function(){o()},t)}function ye(){h=null;i=null;bu();a.removeClass("lock");wi()}function bu(){c&&c.readyState!=0&&(c.pause(),c.currentTime=0)}function pe(n){st=n;n.on("accept",function(){p.emit("status",1);le();Teamlab.saveVoipCall({},h.id,{answeredBy:Teamlab.profile.id},{"async":!0,success:function(n,t){h=t;o()}})});n.on("disconnect",function(){fi||p.emit("status",0);ae()});n.accept()}function we(){ki()}function be(){ir=Date.now();bt=setInterval(function(){ke()},1e3)}function ke(){var r=Date.now(),i=r-ir,n=~~(i/6e4),t=~~((i-n*6e4)/1e3);n=n/10<1?"0"+n:n;t=t/10<1?"0"+t:t;ci.text(n+":"+t)}function ki(){bt&&(clearInterval(bt),bt=null)}function de(){return ku("mp3")}function ge(){return ku("wav")}function ku(n){try{var t=document.createElement("audio");if(!!t.canPlayType)switch(n){case"ogg":return t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"");case"mp3":return t.canPlayType("audio/mpeg;").replace(/^no$/,"");case"wav":return t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"");case"m4a":return(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,"")}}catch(i){}return!1}function du(){tu.displayLoading()}function di(){tu.hideLoading()}function et(){toastr.error(ut.CommonJSErrorMsg)}var y=!1,ui=!1,ct=!1,pt=[],lt=null,t=null,fi=!1,wt=!1,u=[],h=null,i=null,gi="+1",nr="US",tr="US",ot=null,c=null,gu=5e3,bt=null,ir=null,p=null,st=null,kt,d="disable",dt="active",rr,gt,l,ur,fr,er,or,ei,sr,hr,cr,oi,lr,g,ni,ar,a,ti,s,it,rt,ii,v,si,w,vr,b,nt,hi,yr,ri,tt,e,pr,wr,br,nf,ci,kr,dr,gr,nu,at,vt,yt,li,tu=LoadingBanner,iu=ASC.Resources.Master,ut=iu.ResourceJS,r={online:0,busy:1,offline:2},k,f={outgoingStarted:0,outgoingGoing:1,outgoingCompleted:2,incomingStarted:3,incomingGoing:4,incomingCompleted:5},ai=!0,vi;return{init:tf,makeCallToContact:wu}}(jq);jq(function(){ASC.CRM.Voip.PhoneView.init()});
